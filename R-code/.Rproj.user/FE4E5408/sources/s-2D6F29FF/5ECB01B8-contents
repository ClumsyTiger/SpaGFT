# The goal of this script is to unify data format into Seurat object and Scanpy object
#-----------------------------------------------------------------------------------------
# Introduction: There are two dominant tools in transcriptional analysis, including data reading, cleaning, and downstream analysis. 
# The first name is Seurat, an R package, and the other is scanpy, a python package. 
# The two packages have their only data format and structure (e.g., Seurat uses "h5seurat" and scanpy uses "h5ad" ). 
# Fortunately, h5seurat and .h5ad are transferable to each other. 
# more information can be studied from here https://satijalab.org/seurat/articles/conversion_vignette.html and https://anndata.readthedocs.io/en/latest/
# Therefore, in this Rscript, we use one chick heart data to show how to clean Visium data and generate two objects.
#-----------------------------------------------------------------------------------------
# set environment and install packages
# set your working directory to change your workspace
setwd("e:/Data and Code/Source data/chicken heart visium/")
# please install the package name Seurat and SeuratDisk using the following commands
# install Seurat and hdf5r
install.packages("Seurat")
install.packages("hdf5r")
# check remote package and install it, remotes package is designed for installing packages from GitHub.
if (!requireNamespace("remotes", quietly = TRUE)) {
  install.packages("remotes")
}
# install seurat-disk package for converting h5ad and h5seurat.
remotes::install_github("mojaveazure/seurat-disk")
# load package
library(Seurat)
library(SeuratDisk)
#-----------------------------------------------------------------------------------------

# read spatial data and creat seurat object
Data_path <- paste0("./GSM4502482_chicken_heart_spatial_RNAseq_D4_filtered_feature_bc_matrix.h5")
# read visium data
# notice: this is only for reading visium data. 
# notice: There is other various data format from different spatial technologies, such as slide-seq and ST. 
# notice: Please use approriate data command to read the data.
expression_df <- Read10X_h5(filename = Data_path)
# create seurat object
expression_df <- CreateSeuratObject(expression_df)
# save Seuratobject usin this name. 
SaveH5Seurat(expression_df, filename = "D4_Visium_ChikenHeart_expression.h5seurat")
# convert h5seurat to h5ad
Convert("D4_Visium_ChikenHeart_expression.h5seurat", dest = "h5ad")

# read save spatial x y coordinate from csv format file
spatial_info <- read.csv("./chicken_heart_spatial_RNAseq_D4_tissue_positions_list.csv",header = F)
# create data frame with 2 columns.
spatial_info <- data.frame(row.names = spatial_info$V1,
                           x = spatial_info$V4,
                           y = spatial_info$V3)
# matching expression matrix and corridnate
spatial_info <- spatial_info[colnames(expression_df),]
# add ID column to spatial_info dataframe
spatial_info <- cbind(ID = rownames(spatial_info), spatial_info)
# write csv for spatial information.
write.csv(spatial_info,file = "D4_Visium_ChikenHeart_xy.csv",row.names = F,quote = F)
# job done.


